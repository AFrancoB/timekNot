// Generated by purs version 0.15.15
import * as AST from "../AST/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_DateTime from "../Data.DateTime/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_List from "../Data.List/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Rational from "../Data.Rational/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Tempo from "../Data.Tempo/index.js";
import * as Data_Time_Duration from "../Data.Time.Duration/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Effect_Now from "../Effect.Now/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Foreign from "../Foreign/index.js";
import * as Novus from "../Novus/index.js";
import * as Parser from "../Parser/index.js";
import * as Parsing from "../Parsing/index.js";
import * as TimePacketOps from "../TimePacketOps/index.js";
import * as Voices from "../Voices/index.js";
import * as WebDirt from "../WebDirt/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Effect.bindEffect);
var show = /* #__PURE__ */ Data_Show.show(/* #__PURE__ */ Data_List_Types.showList(AST.expressionShow));
var traverse_ = /* #__PURE__ */ Data_Foldable.traverse_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var adjust = /* #__PURE__ */ Data_DateTime.adjust(Data_Time_Duration.durationMilliseconds);
var lessThanOrEq = /* #__PURE__ */ Data_Ord.lessThanOrEq(Data_DateTime.ordDateTime);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showString);
var fromFoldable = /* #__PURE__ */ Data_List.fromFoldable(Data_Foldable.foldableArray);
var toRational = /* #__PURE__ */ Data_Rational.toRational(Data_Rational.toRationalInt);
var show2 = /* #__PURE__ */ Data_Show.show(/* #__PURE__ */ Data_Map_Internal.showMap(Data_Show.showString)(Data_DateTime.showDateTime));
var setTempo = function (tk) {
    return function (t) {
        return Effect_Ref.write(Data_Tempo.fromForeignTempo(t))(tk.tempo);
    };
};
var render = function (tk) {
    return function (args) {
        var ws = TimePacketOps.numToDateTime(args.windowStartTime * 1000.0);
        var we = TimePacketOps.numToDateTime(args.windowEndTime * 1000.0);
        return function __do() {
            var program = Effect_Ref.read(tk.program)();
            var vantageMap = Effect_Ref.read(tk.vantageMap)();
            var t = Effect_Ref.read(tk.tempo)();
            var $$eval = Effect_Ref.read(tk["eval"])();
            var tp = TimePacketOps.assambleTimePacket(ws)(we)($$eval)(t)(vantageMap);
            Effect_Console.log(show(program))();
            return Voices.programToForeign(program)(tp)();
        };
    };
};
var playDirty = function (tk) {
    return function (dirt) {
        return function __do() {
            var wStart = Effect_Ref.read(tk.wS)();
            var wEnd = Effect_Ref.read(tk.wE)();
            var events = render(tk)({
                zone: 0,
                windowStartTime: TimePacketOps.fromDateTimeToPosix(wStart),
                windowEndTime: TimePacketOps.fromDateTimeToPosix(wEnd)
            })();
            var x = traverse_(function (x) {
                return WebDirt.playSample(dirt)(Foreign.unsafeFromForeign(x));
            })(events)();
            return x;
        };
    };
};
var renderStandalone = function (tk) {
    return function (d) {
        return function __do() {
            var now = Effect_Now.nowDateTime();
            var prevWE = Effect_Ref.read(tk.wE)();
            var future = Data_Maybe.fromMaybe(now)(adjust(400.0)(now));
            var $22 = lessThanOrEq(prevWE)(future);
            if ($22) {
                var wE = Data_Maybe.fromMaybe(now)(adjust(500.0)(prevWE));
                Effect_Ref.write(prevWE)(tk.wS)();
                Effect_Ref.write(wE)(tk.wE)();
                var t = Effect_Ref.read(tk.tempo)();
                return playDirty(tk)(d.webdirt)();
            };
            return Effect_Console.log(show1("sleep"))();
        };
    };
};
var main = /* #__PURE__ */ pure(Data_Unit.unit);
var launchDirt = function __do() {
    var dirt = WebDirt.newWebDirt({
        sampleMapUrl: "./src/samples/sampleMap.json",
        sampleFolder: "./src/samples"
    })();
    WebDirt.initializeWebAudio(dirt)();
    return dirt;
};
var launch = function (v) {
    return function __do() {
        Effect_Console.log("timekNot: launch")();
        var launchTime = Effect_Now.nowDateTime();
        var program = Effect_Ref["new"](fromFoldable([ new AST.TimeExpression(Data_Map_Internal.empty) ]))();
        var tempo = bind(Data_Tempo.newTempo(toRational(1)(1)))(Effect_Ref["new"])();
        var vantageMap = Effect_Ref["new"](Data_Map_Internal.empty)();
        var $$eval = Effect_Ref["new"](launchTime)();
        var wS = Effect_Ref["new"](launchTime)();
        var wE = Effect_Ref["new"](launchTime)();
        return {
            program: program,
            tempo: tempo,
            "eval": $$eval,
            vantageMap: vantageMap,
            wS: wS,
            wE: wE
        };
    };
};
var check$prime = function (v) {
    return function (v1) {
        if (v1 instanceof Data_Either.Left) {
            return new Data_Either.Left(Parsing.parseErrorMessage(v1.value0));
        };
        if (v1 instanceof Data_Either.Right) {
            var v2 = Parser.check(v)(v1.value0);
            if (v2) {
                return new Data_Either.Right(v1.value0);
            };
            if (!v2) {
                return new Data_Either.Left("failed the check, time bites it's own tail");
            };
            throw new Error("Failed pattern match at Main (line 106, column 30 - line 108, column 89): " + [ v2.constructor.name ]);
        };
        throw new Error("Failed pattern match at Main (line 104, column 1 - line 104, column 74): " + [ v.constructor.name, v1.constructor.name ]);
    };
};
var define = function (tk) {
    return function (args) {
        return function __do() {
            Effect_Console.log("timekNot: evaluate")();
            var program = Effect_Ref.read(tk.program)();
            var currentVM = Effect_Ref.read(tk.vantageMap)();
            Effect_Console.log("currentVM" + show2(currentVM))();
            Effect_Console.log("programDefined: " + show(program))();
            var tempo = Effect_Ref.read(tk.tempo)();
            var $$eval = Effect_Now.nowDateTime();
            var pr = check$prime(currentVM)(Parsing.runParser(args.text)(Parser.parseProgram));
            if (pr instanceof Data_Either.Left) {
                return {
                    success: false,
                    error: pr.value0
                };
            };
            if (pr instanceof Data_Either.Right) {
                Effect_Ref.write($$eval)(tk["eval"])();
                Effect_Ref.write(pr.value0)(tk.program)();
                Effect_Ref.write(Novus.processVantage(Parser.getVantageMap(pr.value0))(currentVM)($$eval)(tempo))(tk.vantageMap)();
                return {
                    success: true,
                    error: "bad syntax"
                };
            };
            throw new Error("Failed pattern match at Main (line 96, column 3 - line 102, column 52): " + [ pr.constructor.name ]);
        };
    };
};
export {
    main,
    launchDirt,
    launch,
    define,
    check$prime,
    render,
    setTempo,
    renderStandalone,
    playDirty
};
